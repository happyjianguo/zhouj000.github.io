---
layout:     post
title:      "银行技术架构(一) 支付清算体系"
date:       2019-12-24
author:     "ZhouJ000"
header-img: "img/in-post/2019/post-bg-2019-headbg.jpg"
catalog: true
tags:
    - 银行技术架构
--- 




中国的支付清算有两套体系
1. 当你去ATM取钱时，用的是**央行**的CNAPS(中国现代化支付清算系统)
2. 当你用支付宝买买买时，用的是**第三方支付**的清算系统


# 央行的CNAPS

假如你拿着一张工行卡去建行的ATM取了100元，这时候就发生了**跨行业务**：  
1、建行系统告诉工行系统，有个工行用户要在我这儿取100元，能不能让他取？  
2、工行说，他的工行账户够扣100元，你先帮我给了吧！  
3、建行ATM就吐出100元给你  
对你而言，拿到ATM现金100元，你的工行账户里也被扣了100元，这个交易就结束了。但是建行先替工行给了你100元，这里形成了一个**银行间的债务关系**：工行欠建行100元

这100元何时还？怎么还？虽说是银行之间的事，但是只有等这100元还清了，银行才会把这笔交易当做是真正的**完结**了。可见，银行的一次跨行取款可以分为**支付**和**清算**两个步骤

## 信息流与资金流

从你塞卡到ATM吐出钞票，这个过程称为**支付**(Payment)。支付反映的是**交易的信息流**，一般都是**实时**的。当你在建行ATM取款时，工商银行层面只是在它内部账户做了一次**记账**而已，工商银行的资金**并未减少**

工行还给建行100元，这个过程称为**清算**(Clearing)。建行和工行之间一定会发生**实际的资金划转以清偿债权债务关系**，所以清算反映的是**交易的资金流**。银行之间可以每天清算一次，也可以隔一段时间再清算，不过大多数情况下的清算都是**非实时的**

现代社会几乎所有的商业行为，最终都会产生交易。而所有的交易，除了物物交换，最终都体现在**银行账户间的资金划拨**上，因此一个国家的**支付清算系统**(Payment and Clearing System)是最基础的工程。这个系统涉及两个问题：  
1、信息流如何传递 —— 即建行和工行之间以什么方式通信？  
2、资金流如何清算 —— 即工行什么时候，以什么方式还给建行100块？

这两个问题的解决方案，就是我们现在央行的CNAPS，CNAPS也是逐渐演化而来的，下面看下从古至今的人们是怎么解决这两个问题的

## 系统演化

### 晋商的票号和镖局

早在清道光(1823年)年间，山西平遥商人就创立了"日升昌"等专门办理汇款业务的**票号**（古代的票号、钱庄就是现代银行的雏形)，当时的票号也是支持**异地汇款**业务的

客户来"日升昌"汇款，交了银子之后，票号就开出**汇票**给客户。跟银行一样，票号也有**总号和分号**，客户可以携带汇票或把票寄给亲人，只要凭票就可以到"日升昌"全国各地的**分号兑出银子**，分号给客户兑换之后先记**内部账**，日后再和**总号清算债务**

从此之后，商人在城市之间贸易可以不用携带大量的银子。而**汇票在不同城市的各个分号之间流转也形成了很多债务**，有大量的银子需要周转，**镖局**就专为票号来运送银子以及为商人运送票据，有点类似于现在为银行押钞的威豹，不过镖局的手续费可是高达5%的

在这个时期，信息流和资金流可以总结如下：  
1、信息流：**汇票 + 账本**(手工记账)是票号在支付环节的信息载体  
2、资金流：镖局替票号运送资金

### 联行信件和邮电局

到现代银行出现后，银行间开始了一套基于**"同业头寸"**的清算方式。从两百年前老罗斯柴尔德拉拢一帮银庄的掌柜跟他们商量，"以后我的客户拿着我家的银票可以到你家取金币，然后你再拿着银票到我家取金币，作为回报我也允许你的客户到我家取金币"。从这个时候开始，标志着现代银行的**通存通兑**业务就开始了。由于大多时候双方客户都有**交叉**，实际需要相互取的金币并不多：比如你的客户在我这里取了1000金币，我的客户在你那里取了800金币，然后我们两家一比对账本双方认可，你再给我200金币。再把银票一交换，我们双方的账就清了，这个过程就叫**清算**，其中比对账本的过程就是**对账**。从这次打通不同银行间银票的通兑开始，银行间清算业务就一直延续到现在

> 头寸：头寸对应的英文是position，就是指仓位，也可以说是资产存量。人行是给商业银行记账的，一家银行在央行那里的资金就叫头寸，银行司库对头寸进行管理就是管理资金的流动性，避免资金闲置

在了解了银行间通存通兑的业务原理后，还有一些细节需要说明：  
1、【A银行】怕【B银行】的客户在【A银行】这儿取了钱之后，【B银行】不认账。所以为了保险起见，银行之间会要求对方银行先来**开个户**并且存一部分钱进来作为**备付金**，或者叫**存款准备金**。这个**备付金账户是专门用于清算的同业头寸户**  
2、因此【A银行】就需要在所有银行都开户，才能实现通存通兑  
3、我国的银行显然也参照了这一套来实现跨行交易，银行之间互相都开了备付金账户。此时，每家银行都是一个清算机构，为银行间的资金往来做清算
![yhjqs](yhjqs.jpg)

一直到1984年**中国人民银行专门行使中央银行职能**之后，我们国家确立了**法定存款准备金制度**。央行的**备付金系统**正式确立。此时，银行跨行的资金清算有两种选择：  
1、老办法，继续在所有往来的银行开立清算账户清算  
2、**所有金融机构都在央行开立清算账户，由央行为商业银行统一清算**
![yhbzj](yhbzj.jpg)
显然大家都想用第二个方案。然而在那个时代，央行能承担的职责是很有限的，而且各银行内部数据还没有集中，没有电子化的记账系统，国内甚至都还没有银行卡，客户要转账也没有满大街的ATM。总之一句话，国内的金融环境还没有达到让央行推行全国统一结算制度的客观条件

为了满足跨行结算的需求，央行当时提出商业银行要**"自成联行系统，跨行直接通汇，相互发报移卡，及时清算资金"**。也就是说同一家银行的**总行及分支**机构称为"联行系统"。同一联行内的资金结算，**由联行总行自己做**，自己内部解决。跨银行之间要能支持直接汇款。跨行业务可以由**央行清算**，也可以由商业银行**自己清算**。这个各家银行系统很不智能，体验很差的时期，我们称为"全国手工联行"时期

于是，每家银行都可以接受跨行的汇款，**银行每天自行"轧差"**，各种交易汇总计算后，将需要告知其他行的**交易信息**写成一张张特定的**公文**，**加盖印鉴后在银行间送来送去**。这种公文叫做**联行信件**，而收发联行信件就是当时**邮电局**的重要业务

> 轧差

可以说一直到1990年，我国的支付结算系统和明清时期的票号相比，并没有太大的改进。**汇票和账本手工记账**依然是银行在支付环节的**信息载体**，解决信息流问题。**邮电局**取代了镖局，为银行收发联行信件，但是效率依旧不高，资金**在途**时间往往在一周以上。至于资金流问题，则由**商业银行自行结算和央行统一结算两种方式一起解决**

### EIS

随着银行业的不断发展，银行每天处理各类跨行业务的数量增多，各家银行之间的债权债务关系变得非常复杂，由各家银行自行轧差进行清算变得非常困难。这种状况要求央行必须承担起一个**全国清算中心**的角色

于是，央行在1989年12月6日，发布了"关于改革联行清算制度的通知"。随后中国人民银行清算中心建成，专门为金融机构提供支付清算服务。这个清算中心包括NPC和CCPC：  
1、NPC(National Process Center，国家金融清算总中心)  
2、CCPC(City Clearing Processing Center，城市处理中心)

1991年4月1日，基于金融卫星通讯网的应用系统 —— 全国电子联行系统(EIS)开始试运行。EIS作为中国支付清算系统的前身，是人民银行**专门用于处理异地(包括跨行和行内)资金清算和资金划拨的系统**。它**连接了商业银行、央行、NPC和CCPC**

假设客户在深圳建行汇款给北京工行，通过EIS处理一次跨行汇款的流程如下：
![eis](eis.jpg)
1、商业银行(汇出行)接收其客户的汇款请求后，向人民银行当地分行(发报行)**提交支付指令**(转汇清单)。支付指令可以是纸质凭证，或磁介质信息，或联机电子报文  
2、发报行**借记**汇出行账户后，按收报行将支付信息**分类、打包**，通过CCPC经卫星地面小站即时发往**清算总中心**。如果汇出行账户余额不足，则该支付指令必须排队等到汇出行余额够扣  
3、清算总中心收到转汇电文，经**记账**并按人民银行收报支行将支付指令**清分**后，通过卫星链路即时发送到相应的收报行  
4、收报行对汇入行账户**贷记**后，以生成的纸凭证或电子报文方式通知汇入行  
5、汇入行作**账务处理**后，以来账的反方向，向汇出行发送**确认**的答复信息，完成一笔**汇兑过程**  
6、**总中心和分中心每日核对**无误后，**轧平**当日的电子联行**账务**，以存、借反映资金关系。就是说，**各地的资金存欠差额，均纳入人民银行系统内反映**

> 清分：清分是付款行和收款行交换支付信息，根据支付指令计算借贷双方差额的过程；如果是刷pos机，清分就是银联做的

> 轧平

在这个跨行异地汇款流程中，**金融卫星通讯网和EIS系统解决了信息流问题**；**NPC和CCPC解决了资金流问题**。从此之后，各个银行之间的跨行汇款就可以直接通过这样的电子化操作来完成了，客户的资金在途时间缩短到了一两天，这也算是中国金融系统的一大里程碑了
![eis2](eis2.jpg)

### 央行支付清算系统CNAPS

在1991年EIS试运行后，又发生了两件大事：  
1、各家商业银行的内部联网系统纷纷建成投产，银行**内部资金划转**都可以通过自己的核心系统解决了。这意味着各大行都可以做**电子化的行内清算**了，行内异地转账就不用再依赖EIS  
2、1991年10月，中国开始着手建设中国国家金融通信网(CNFN)和中国现代化支付系统(CNAPS，China National Automatic Payment System)。这一项目由世界银行提供贷款，由英国PA咨询公司承担设计咨询工作。从此，全国电子联行(EIS)系统逐步向CNAPS过渡

到了21世纪，IT技术飞速发展，央行的CNAPS**一代系统(大小额支付系统)**也开始走上历史舞台。中国的支付清算步入了现代化支付系统CNAPS的时代

#### 大小额支付系统

2002年，央行大额实时支付系统(HVPS)投产，用于处理同城和异地的商业银行跨行之间(也包括行内一定金额以上的)大额贷记业务。2005年，央行小额批量支付系统（BEPS）投产，用来处理同城和异地纸凭证截留的借记支付业务以及每笔金额在5万以下的小额贷记支付业务。简单来讲，**各银行的跨行转账可以使用央行的大小额系统来完成**

大小额系统之间的区别：  
1、**大小额的开放时间不同**：大额系统是工作日的8:30 ~ 17:00，所以在节假日经常会收到银行通知说某些业务暂停了，就是因为央行在节假日对大额系统做维护。小额系统全年无休，7*24小时工作  
2、**业务处理上不同**：大额是每笔交易都**实时发送，实时清算的**，所以基本上能实时到账，**跨行资金零在途**；小额系统是在收集若干笔交易后打一个**包**统一处理，**定时清算**。所以，用小额系统转账经常要几分钟甚至半个小时才能到账，**银行间头寸交割也是非实时的**。尽管理论上跨行转账业务不管用大额还是小额，一般在几分钟内都能到账，但是因为要经过央行，所以在这一时期基本没有银行敢向客户承诺资金多久能到账  
3、**金额不同**：大额系统没有金额限制，小额系统支持的单笔金额上限是5万元。从用途上讲，大额系统侧重于资金转移的**时效性**，主要用于资本市场、货币市场交易和大额贸易资金结算。小额系统对数据**吞吐量**要求较高，主要用于小额贸易支付和个人消费服务

#### 超级网银

2013年10月6日，央行的第二代支付系统正式投产运行，其中包括2010年就推出的网上支付跨行清算系统(俗称"超级网银")。超级网银是对大小额支付系统的一个补充，有两大亮点：  
1、接入机构不再限于银行：支付宝、财付通等第**三方支付也可以接入**，所以有的第三方支付给商户提供的提现代发功能就是基于超级网银做的  
2、7*24小时实时到账，单笔上限5万元。这就相当于在非工作日非营业时间增加了一种大额支付系统特性的渠道了。只不过金额限制是跟小额系统一致的

## 银行的渠道

有了大小额系统和超级网银。银行对不同的客群和不同的场景，做了不同的渠道。我们最经常接触的大概就是银行柜台、手机网银、POS机和ATM机，它们采用不同的清算系统来实现跨行交易
+ 银行柜台：直接用大小额系统
+ 手机网银：大小额系统 + 超级网银
	- 我们使用的时候，可以看到跨行转账会有普通和加急两种方式，实际上普通是走的大小额系统，加急走的是超级网银
+ ATM：信息流由银联处理，即银联CUPS为银行间交易提供**指令的转接和清分**；资金流则由银联通过**大额系统**完成银行间的资金划拨
+ POS：跟ATM类似，由银联处理信息流。不过资金流分两部分，**发卡行和收单行之间**的资金划拨由银联通过大额系统完成；**收单行与商户账户**的资金划拨由银联通过小额系统完成
![sjwy](sjwy.jpg)

=============
网银互联是人行的，也叫超级网银，之前基金的赎回走的就是这个通道。	渠道

网联是人行牵头新弄的网联清算平台									机构
=============

> 清分

这里看下POS几的刷卡流程，以星巴克刷卡为例：  
+ 持卡人 —— 你
+ 发卡行 —— 你办这张卡的银行，我们假设是工行
+ 商户 —— 星巴克，我们假设星巴克的账户开在建行
+ 收单行 —— 星巴克的刷卡机的归属银行，假设也是建行
+ 转接机构 —— 银联
+ 清算机构 —— 银联和人行
于是，当你用工行卡在星巴克消费的时候，资金流和现金流是这样发生的：
+ 你在收单行(建行)的POS机上刷卡消费(信息流)
+ 建行将消费报文发送给银联(信息流)
+ 银联交易系统记录交易数据，将消费报文给你的发卡行(工行)(信息流)
+ 工行从你的卡中实时扣费，完成实时结算，并回复报文给银联(【资金流】)
+ 银联更新交易数据，回复报文给建行的POS机(信息流)
+ 银联在其清算系统完成清分(信息流)
+ 银联通过大额支付系统，完成工行与建行清算账户的资金划拨(**跨行清算**)(【资金流】)
+ 银联通过小额支付系统或当地票据交换系统，完成建行和星巴克结算账户的资金划拨(**收单清算**)(【资金流】)
在这个过程中，银联提供两种清算：
+ 建行和工行的清算叫**"跨行清算"**
+ 建行和星巴克的建行账户之间的清算叫**"收单清算"**
无论是跨行清算还是收单清算，银联都是作为CNAPS的一个**特许参与者**，使用大小额支付清算系统，完成银行卡业务的资金划拨。本质上，**银联提供交易转接、清分和对账，人行提供结算**

ATM机与POS刷卡一致，只不过不用进行收单清算，没有商户参与

> 结算：结算涉及付款人收款人的开户银行和央行，通过央行划转备付金账户来清偿债权债务关系

清算就是信息流的计算，结算是资金流的计算 ?
 结算是指将清算过程产生的待结算头寸分别在发起行、接收行进行相应的会计处理，完成资金转移，并通知收付双方的过程。当前，大多数银行结算业务的完成主要通过两类账户：一是银行间互相开立的代理账户，二是开立在央行、独立金融机构如银联、或者第三方支付机构的账户

http://www.360doc.com/content/18/0506/00/45163544_751472950.shtml

国外银行 ->(主动/被动) 香港花旗 ->file(钱，给谁) 跨境国际 -> 加款单 -><条件> -> 虚拟卡 

1.花旗 -> (信息流) -> 跨境国际 记账 -> 国内银行备付金 -> 汇兑(信息流) -> 国内银通 记账 -> 商户 -> 分发(汇兑 + 打款)<我们垫资>
2.(资金流) 轧差 + 打包 -> 香港花旗 -> 国内备付金 

国内监管：资金流入，流出都要监管
国外监管：资金流入



清分就是记谁给谁杠、放炮等。
清算就是打完大家交流一下看看记的对不对，谁进多少谁出多少 (含对账)。
结算就是决定谁进的钱由谁来出
头寸可指投资者拥有或借用的资金数量。银行头寸是银行系统对于可用资金调度的一个专业的叫法，每个银行或者期货都有自己的资金头寸







## 体系结构

首先看下支付行业共有哪些**机构**参与：  
1、**中国人民银行**：支付领域的王者兼创造者，发布各项政策规范的存在。央行并不涉及支付方面的具体业务，更多时候以一个管理者的身份坐镇市场  
2、**中国银联**：清算组织机构，连接各大银行的桥梁，为满足各家银行互联互通交易而产生的，银行间跨行的资金清算都要通过它来实现，本质上是协议组织，目前主要是负责线下业务，不过银联的快捷支付和云闪付也涉及线上业务  
3、**网联**：网联与银联同等地位，主要负责线上(互联网)业务，为各家第三方支付公司互联互通交易，主要是监控第三方支付机构资金流向，国内第三方支付"断直连"  
4、**第三方支付机构**：支付宝、微信支付等，指具备实力和信誉保障的第三方企业和国内外的各大银行签约，为买方和卖方提供的信用增强。在银行的直接支付环节中增加一中介，在通过第三方支付平台交易时，买方选购商品，将款项不直接打给卖方而是付给中介，中介通知卖家发货；买方收到商品后，通知付款，中介将款项转至卖家账户。正规的第三方支付机构必须拥有央行的认可资质，也就是必须获得央行颁发的支付业务许可证才可以开展业务。支付业务许可证的类型一般为：银行卡收单，互联网支付，预付费卡发行。其他如电话支付、数字电视支付等等基本可以忽略  

https://www.zhihu.com/question/51674638
http://doc.cocolian.cn/essay/overview/2017/04/01/concept-01-overview/
https://www.zhihu.com/question/19892912

这是一代的，二代增加了网上支付跨行清算系统(超级网银)
![cnaps-1](cnaps-1.jpg)
商业银行在CNAPS体系中：  
+ 行内的交易：由各个银行的行内业务系统来自行解决信息流和资金流问题  
+ 跨行的交易分渠道处理
	- 柜台和网银等渠道，商业银行直接直连央行的大小额以及超级网银来解决信息流和资金流问题
	- ATM和POS渠道，则是由银联的CUPS来对接各大商业银行做支付转接，解决信息流问题；银联同时提供清分和对账服务，对完账之后再调用央行大小额系统解决资金流问题

https://www.jianshu.com/p/84a90c9c58c6


![zgzf](zgzf.jpeg)	
+ 大额实时支付系统: 大额实时支付系统是处理同城和异地跨行之间和行内的大额贷记及紧急小额贷记支付业务，人民银行系统的贷记支付业务以及即时转账业务等的应用系统
+ 小额批量支付系统: 小额批量支付系统主要处理同城和异地纸凭证截留的借记支付业务和规定金额(5万元)以下的小额贷记支付业务，支付指令批量发送，轧差净额清算资金，旨在为社会提供低成本、大业务量的支付清算服务
	- 小额批量支付系统实行每周7*24小时连续运行
	- 2015年7月11日起，周末及法定节假日期间小额支付系统普通贷记业务的限额调整为50万元/笔
+ 全国支票影像交换系统: 全国支票影像交换系统是指运用影像技术将实物支票转换为支票影像信息，通过计算机及网络技术将支票影像信息传递至出票人开户银行提示付款的业务处理系统
	- 该系统实现了支票的全国通用，使支票用途更加广泛，结算更加便捷。全国支票影像交换系统使支票的使用范围由同一个城市扩大到了全国
+ 境内外币支付系统: 境内外币支付系统是我国第一个支持多币种运行的全国性银行间外币实时全额结算系统，为我国境内的银行业金融机构和外币清算机构提供外币支付服务
+ 电子商业汇票系统: 电子商业汇票系统是由中国人民银行批准建立的，依托网络和计算机技术，接收、登记、转发电子商业汇票数据电文，提供与电子商业汇票货币给付、资金清算行为相关服务并提供纸质商业汇票登记查询和商业汇票公开报价服务的综合性业务处理平台
+ 网上支付跨行清算系统: 网上支付跨行清算系统是以电子方式逐笔实时处理跨行网上支付、电话支付、移动支付等新兴电子支付业务的应用系统。网上支付跨行清算系统逐笔发送支付指令，实时轧差，定时净额清算资金，目前处理金额限定为5万元以下
	- 网上支付跨行清算系统提供安全、高效的公共系统支付清算服务平台，系统实行每周7*24小时连续运行，提供全时、高效的支付清算服务

	
	
	



https://blog.csdn.net/qq_40834299/article/details/78929799
http://www.mpaypass.com.cn/news/201904/10115450.html
https://zhuanlan.zhihu.com/p/94301846
http://www.lovehhy.net/News/View/478224


参考：  
[中国的支付清算体系是怎么玩的？](https://zhuanlan.zhihu.com/p/21249493)  

