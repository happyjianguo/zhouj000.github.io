---
layout:     post
title:      "Spring(一)"
date:       2018-08-19
author:     "ZhouJ000"
header-img: "img/in-post/2018/post-bg-2018-headbg.jpg"
catalog: true
tags:
    - java
    - spring
--- 

<font id="last-updated">最后更新于：2018-08-20</font>

# 准备

github上clone [spring](https://github.com/spring-projects/spring-framework.git) 最新源码。当前github最新版本5.1.0.BUILD-SNAPSHOT，正式版本5.0.8.RELEASE。

spring由[gradle](https://gradle.org/)编译。

# Spring IOC核心

## BeanFactory
BeanFactory是IOC容器的核心接口，它定义了IOC的基本功能，负责读取bean配置文档，管理bean的加载，实例化，维护bean之间的依赖关系，负责bean的声明周期。它主要定义了getBean方法。getBean方法是IOC容器获取bean对象和引发依赖注入的起点。BeanFactory只能管理单例(Singleton)Bean的生命周期。它不能管理原型(prototype非单例)Bean的生命周期。这是因为原型Bean实例被创建之后便被传给了客户端，容器失去了对它们的引用。
```java
/**
 * 用来引用一个实例，或把它和工厂产生的Bean区分开，就是说，如果一个FactoryBean的名字为myJndiObject，那么，&myJndiObject会得到那个Factory
 */
String FACTORY_BEAN_PREFIX = "&";

<T> T getBean(Class<T> requiredType) throws BeansException;
<T> T getBean(Class<T> requiredType, Object... args) throws BeansException;
Object getBean(String name) throws BeansException;
<T> T getBean(String name, Class<T> requiredType) throws BeansException;
Object getBean(String name, Object... args) throws BeansException;
```

### DefaultListableBeanFactory

I:ListableBeanFactory： 可以列举所有bean实例，实现预加载所有bean定义。  
I:HierarchicalBeanFactory： 管理双亲IoC容器规范，比如说getParentBeanFactory()这样的方法。  
I:AutowireCapableBeanFactory： 定义了bean的自动装配规则。

![dubbo-DefaultListableBeanFactory](/img/in-post/2018/8/DefaultListableBeanFactory.png)

继承自AbstractAutowireCapableBeanFactory，并实现了一个外来接口BeanDefinitionRegistry，是整个bean加载的核心部分，是spring注册及加载bean的默认实现。XmlBeanFactory就是继承自DefaultListableBeanFactory。


## ApplicationContext

BeanFactorty接口提供了配置框架及基本功能，但是无法支持spring的aop功能和web应用。而ApplicationContext接口作为BeanFactory的派生，因而提供BeanFactory所有的功能。ApplicationContext是IOC容器另一个重要接口，是spring提供的一个高级IOC容器，而且ApplicationContext还在功能上做了扩展，相较于BeanFactorty，ApplicationContext还提供了以下的功能：   
1 . MessageSource，提供国际化的消息访问  
2 . 资源访问，如URL和文件  
3 . 事件传播特性，即支持aop特性  
4 . 载入多个(有继承关系)上下文 ，使得每一个上下文都专注于一个特定的层次，比如应用的web层

### XmlWebApplicationContext

![XmlWebApplicationContext](/img/in-post/2018/8/XmlWebApplicationContext.png)

从web应用的根目录读取配置文件，需要先在web.xml中配置，可以配置监听器或者servlet来实现
```
<context-param>
	<param-name>contextConfigLocation</param-name>
	<param-value>/WEB-INF/myApplicationContext.xml</param-value>
</context-param>

<listener>
	<listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
</listener>

<servlet>
	<servlet-name>context</servlet-name>
	<servlet-class>org.springframework.web.context.ContextLoaderServlet</servlet-class>
	<load-on-startup>1</load-on-startup>
</servlet>
```

### ClassPathXmlApplicationContext

从classpath的xml配置文件创建，可以从jar包中读取配置文件
```java
ApplicationContext factory = new ClassPathXmlApplicationContext("classpath:applicationContext.xml");
ApplicationContext factory = new ClassPathXmlApplicationContext("applicationContext.xml"); 
ApplicationContext factory = new ClassPathXmlApplicationContext("file:E:/Workspaces/Test/.../applicationContext.xml");
```

## Resource

用于封装底层资源，抽象了所有Spring内部使用到的底层资源：File、URL、Classpath等。定义了3个判断当前资源状态的方法：存在性(exists)、可读性(isReadable)、是否打开(isOpen)。还提供了不同资源到URL、URI、File类型的转换，以及获取相关信息的方法。有了Resource接口便可以对所有资源文件进行统一处理。

对不同来源的资源文件都有对应的Resource实现：文件(FileSystemResource)、Classpath资源(ClassPathResource)、URL资源(UrlResource)、InputStream资源(InputStreamResource)、Byte数组(ByteArrayResource)等。


## BeanDefinitionReader
![BeanDefinitionReader](/img/in-post/2018/8/BeanDefinitionReader.png)

该类的作用是读取Spring的配置文件的内容，并将其转换成Ioc容器内部的数据结构，而容器的数据结构就是BeanDefinition。
该类的功能概括的讲可分为两步：  
1 . 负责BeanDefinition的资源定位，是获取Resource实例对象的过程。BeanDefinitionReader本身不具备该功能，而是通过ResourceLoader获取Resource实例  
2 . 负责BeanDefinition的载入，指的是读取Resource内容并加载为Doucument的过程，然后利用documentReader对配置文件的内容进行解析
```java
int loadBeanDefinitions(Resource resource) throws BeanDefinitionStoreException;
int loadBeanDefinitions(Resource... resources) throws BeanDefinitionStoreException;
int loadBeanDefinitions(String location) throws BeanDefinitionStoreException;
int loadBeanDefinitions(String... locations) throws BeanDefinitionStoreException;
```
![BeanDefinitionReader-flow](/img/in-post/2018/8/BeanDefinitionReader-flow.png)

从xml配置文件读取就是XmlBeanDefinitionReader。


## BeanDefinition
Spring容器启动的过程中，会将Bean解析成Spring内部的BeanDefinition结构，BeanDefintion定义了Bean在IoC容器内的基本数据结构。

![BeanDefinition](/img/in-post/2018/8/BeanDefinition.png)

[Spring 源码之 BeanDefinition阅读](https://blog.csdn.net/lh513828570/article/details/74078804)

### AbstractBeanDefinition

提供了BeanDefinition接口的全部实现。是一个基本的框架。  
其子类有：  
1 . RootBeanDefinition(表示父级)
2 . ChildBeanDefinition(表示子级)
3 . GenericBeanDefinition(一般的BeanDefinition实现)


